<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WBS board</title>
  <meta name="description" content="ë‹¨ì¼ HTML íŒŒì¼ë¡œ ë™ì‘í•˜ëŠ” ë°˜ì‘í˜• ê²Œì‹œíŒ + íšŒì›ê°€ì…/ë¡œê·¸ì¸ + ê´€ë¦¬ì ìŠ¹ì¸ (localStorage ë°ëª¨) + ì´ë¯¸ì§€/ë§ˆí¬ë‹¤ìš´" />
  <style>
    /* ===== Theme Vars ===== */
    :root[data-theme="light"], :root:not([data-theme]){
      --bg1:#f7f8fb; --bg2:#f4f6ff;
      --panel1:#ffffff; --panel2:#fbfdff;
      --muted:#6b7280; --text:#0f172a;
      --brand:#2563eb; --brand2:#22c55e;
      --danger:#ef4444; --ok:#16a34a;
      --b:#e5e7eb; --b2:#d1d5db; --hover:#f1f5ff;
      --radius:16px; --r-sm:10px; --r-lg:22px;
      --ink:#334155; --surface:#f8fafc;
    }
    :root[data-theme="dark"]{
      --bg1:#0b0c10; --bg2:#0e1017;
      --panel1:#141726; --panel2:#10131f;
      --muted:#9094a6; --text:#e5e7ef;
      --brand:#6da8ff; --brand2:#95e0ff;
      --danger:#ff5d5d; --ok:#67e37d;
      --b:#1e2335; --b2:#262c46; --hover:#13172a;
      --radius:16px; --r-sm:10px; --r-lg:22px;
      --ink:#e5e7ef; --surface:#161a2a;
    }

    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Inter,Roboto,Segoe UI,Arial; background:linear-gradient(180deg,var(--bg1),var(--bg2)); color:var(--text)}
    a{color:inherit}
    .container{max-width:1100px; margin:0 auto; padding:20px}
    header{display:flex; align-items:center; justify-content:space-between; gap:14px; padding:10px 0}
    .title{display:flex; align-items:center; gap:10px}
    .nav{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    .panel{background:linear-gradient(180deg, var(--panel1), var(--panel2)); border:1px solid var(--b); border-radius:var(--radius); box-shadow:0 10px 30px rgba(2,6,23,.06)}
    .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; padding:14px; border-bottom:1px solid var(--b)}
    .btn{background:linear-gradient(135deg, var(--brand), var(--brand2)); color:#fff; border:0; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; position:relative; overflow:hidden; transition:transform .15s ease, box-shadow .2s ease; box-shadow:0 2px 10px rgba(37, 99, 235, .18)}
    .btn.secondary{background:var(--surface); color:var(--ink); border:1px solid var(--b2); box-shadow:none}
    .btn.danger{background:linear-gradient(135deg, #f87171, var(--danger)); color:#fff}
    .btn.ok{background:linear-gradient(135deg, #34d399, var(--ok)); color:#fff}
    .btn:active{transform:scale(.98)}
    .muted{color:var(--muted)}

    .row{display:flex; gap:12px; flex-wrap:wrap}
    .search{display:flex; align-items:center; gap:10px; flex:1}
    .search input{flex:1; min-width:180px; background:#fff; color:var(--ink); border:1px solid var(--b2); border-radius:10px; padding:10px 12px; outline:none}
    .search input::placeholder{color:#94a3b8}
    :root[data-theme="dark"] .search input{background:#0f1321; color:var(--text); border-color:#20263a}
    :root[data-theme="dark"] .search input::placeholder{color:#7c86a2}

    .table-wrap{overflow:auto}
    table{width:100%; border-collapse:collapse}
    th,td{padding:12px 10px; border-bottom:1px solid var(--b); font-size:14px; text-align:left}
    th{color:var(--muted)}
    tbody tr:hover{background:var(--hover)}
    .empty{padding:40px; text-align:center; color:var(--muted)}

    .pagination{display:flex; gap:10px; align-items:center; justify-content:flex-end; padding:14px; flex-wrap:wrap}
    .page-btn{background:var(--surface); border:1px solid var(--b2); color:var(--ink); padding:10px 12px; border-radius:10px; cursor:pointer; position:relative; overflow:hidden; transition:transform .15s ease}
    :root[data-theme="dark"] .page-btn{background:#14182a; color:var(--text); border-color: var(--b2)}
    .page-btn.active{background:linear-gradient(135deg, var(--brand), var(--brand2)); color:#ffffff; font-weight:700}

    @media (max-width: 720px){
      th{display:none}
      table, tbody, tr, td{display:block; width:100%}
      tr{border-bottom:1px solid var(--b)}
      td{border:none; padding:10px 14px}
      td[data-th]::before{content: attr(data-th) " Â· "; color:var(--muted); font-weight:600}
      .pagination{justify-content:center}
      .search{flex-direction:column; align-items:stretch}
    }

    dialog{border:0; padding:0; width:min(900px,94vw); background:linear-gradient(180deg,var(--panel1),var(--panel2)); color:var(--text); border-radius:var(--r-lg); box-shadow:0 30px 80px rgba(2,6,23,.18)}
    dialog::backdrop{background:rgba(2,6,23,.35)}
    .dialog-header{display:flex; justify-content:space-between; gap:8px; padding:16px; border-bottom:1px solid var(--b)}
    .dialog-body{padding:16px}

    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width:720px){ .grid{grid-template-columns:1fr} }
    .field{display:flex; flex-direction:column; gap:6px}
    label{font-size:12px; color:var(--muted)}
    input[type="text"], input[type="email"], input[type="password"], textarea{background:#ffffff; border:1px solid var(--b2); color:var(--ink); padding:10px 12px; border-radius:10px; outline:none}
    :root[data-theme="dark"] input[type="text"], :root[data-theme="dark"] input[type="email"], :root[data-theme="dark"] input[type="password"], :root[data-theme="dark"] textarea{background:#0f1321; border-color:#20263a; color:var(--text)}
    textarea{min-height:240px; resize:vertical}

    .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--surface); border:1px solid var(--b2); color:var(--muted); font-size:12px}
    .chip .dot{width:8px; height:8px; border-radius:50%; background:var(--brand2)}

    .title-wrap{display:flex; align-items:center; gap:8px}
    .icon-btn{border:1px solid var(--b2); background:var(--surface); color:var(--ink); border-radius:8px; padding:4px 6px; font-size:12px; cursor:pointer; position:relative; overflow:hidden}
    :root[data-theme="dark"] .icon-btn{background:#161a2a; color:var(--text)}

    /* ===== Editor toolbar & preview ===== */
    .md-toolbar{display:flex; gap:8px; align-items:center; justify-content:flex-end; margin:8px 0}
    .content-body{line-height:1.7; font-size:16px}
    .content-body h1{font-size:28px; margin:20px 0 10px}
    .content-body h2{font-size:22px; margin:18px 0 8px}
    .content-body h3{font-size:18px; margin:16px 0 8px}
    .content-body p{margin:10px 0}
    .content-body ul, .content-body ol{padding-left:22px; margin:8px 0}
    .content-body li{margin:4px 0}
    .content-body img{max-width:100%; height:auto; display:block; margin:10px auto; border-radius:10px; border:1px solid var(--b)}
    .content-body code{background:var(--surface); border:1px solid var(--b2); padding:0 6px; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .help{font-size:12px; color:var(--muted)}

    /* ===== Animations & Motion ===== */
    .ripple{position:absolute; left:0; top:0; border-radius:999px; pointer-events:none; width:12px; height:12px; transform:translate(-50%,-50%) scale(0); opacity:.35; background:currentColor; animation:ripple .6s ease-out forwards}
    @keyframes ripple{to{transform:translate(-50%,-50%) scale(18); opacity:0}}
    .reveal{opacity:0; transform:translateY(10px)}
    .reveal.is-visible{opacity:1; transform:none; transition:opacity .45s ease, transform .45s ease}
    @media (prefers-reduced-motion: reduce){ *{animation-duration:0.001ms !important; animation-iteration-count:1 !important; transition-duration:0.001ms !important; scroll-behavior:auto !important} }

    /* Extra responsive tweaks */
    @media (max-width:560px){
      header{align-items:flex-start}
      .nav{flex-wrap:wrap}
      .nav > .btn, .nav > .btn.secondary, .nav > .btn.danger{flex:1 1 46%}
      .toolbar{gap:12px}
      .row{width:100%; justify-content:space-between}
      #btnNewPost{width:100%}
    }
  /* Icon-only buttons */
    .btn.icon-only, .icon-btn.icon-only, .page-btn.icon-only{width:36px; height:36px; padding:0; display:inline-flex; align-items:center; justify-content:center}
    .nav .btn.icon-only{margin-left:2px; margin-right:2px}
    .btn.icon-only svg, .icon-btn.icon-only svg{width:20px; height:20px; display:block}
    /* Admin tools layout inside dialog */
    .dialog-body .admin-toolbar{display:flex; gap:10px; align-items:center; justify-content:flex-end; padding:12px; margin:-16px -16px 12px; border-bottom:1px solid var(--b); background:linear-gradient(180deg, var(--panel1), var(--panel2)); border-top-left-radius: var(--r-lg); border-top-right-radius: var(--r-lg);}
    .dialog-body .admin-toolbar .btn{box-shadow:none}
    @media (max-width:720px){
      .dialog-body .admin-toolbar{flex-wrap:wrap; justify-content:space-between}
      .dialog-body .admin-toolbar .btn{flex:1 1 32%}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <span style="font-size:28px">ğŸ“‹</span>
        <div>
          <div style="font-size:20px; font-weight:700">WBS ìˆ˜ê°•ìƒ ê²Œì‹œíŒ</div>
          <div class="muted">ìˆ˜ê°•ìƒ ì •ë³´ê³µìœ  ì¼ì§€ ê²Œì‹œíŒ</div>
        </div>
      </div>
      <div class="nav">
        <span id="welcome" class="muted"></span>
        <span id="backupStatus" class="chip" title="ìë™ ë°±ì—… í˜„í™©" style="display:none"><span class="dot"></span><span id="backupText">ë°±ì—… ì¤€ë¹„ë¨</span></span>
        <button class="btn secondary icon-only" id="btnTheme" aria-label="í…Œë§ˆ" title="í…Œë§ˆ"></button>
        <button class="btn secondary" id="btnLogin">ë¡œê·¸ì¸</button>
        <button class="btn secondary" id="btnSignup">íšŒì›ê°€ì…</button>
        <button class="btn" id="btnAdmin" hidden>ê´€ë¦¬ì</button>
        <button class="btn danger" id="btnLogout" hidden>ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </header>

    <section class="panel" aria-label="ê²Œì‹œíŒ">
      <div class="toolbar">
        <div class="search">
          <input id="q" type="search" placeholder="ì œëª©Â·ì‘ì„±ìÂ·ë‚´ìš© ê²€ìƒ‰" aria-label="ê²€ìƒ‰" />
          <button class="btn secondary" id="resetSearch">ì´ˆê¸°í™”</button>
        </div>
        <div class="row">
          <button class="btn" id="btnNewPost">+ ê¸€ ì‘ì„±</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:80px">ë²ˆí˜¸</th>
              <th>ì œëª©</th>
              <th style="width:160px">ì‘ì„±ì</th>
              <th style="width:200px">ì‘ì„±ì¼</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div id="emptyPosts" class="empty" hidden>ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>
      <div class="pagination" id="pager"></div>
    </section>

    <p class="muted" style="margin-top:14px">â€» ë³¸ ë°ëª¨ëŠ” <b>ë¡œì»¬ ì €ì¥ì†Œ(localStorage)</b>ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì‹¤ì œ ì„œë¹„ìŠ¤ìš© ë³´ì•ˆ ê¸°ëŠ¥ì€ í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ê°€ ë§ì„ ê²½ìš° ë¸Œë¼ìš°ì € ì €ì¥ ìš©ëŸ‰ì„ ì´ˆê³¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  </div>

  <!-- Post Dialog -->
  <dialog id="dlgPost">
    <div class="dialog-header">
      <div class="chip"><span class="dot"></span><span id="dlgPostMode">ìƒˆ ê¸€</span></div>
      <button class="btn secondary" id="closePost">ë‹«ê¸°</button>
    </div>
    <div class="dialog-body">
      <form id="postForm">
        <input type="hidden" id="postId" />
        <div class="grid" id="postMeta">
          <div class="field"><label>ì œëª©</label><input id="postTitle" type="text" required /></div>
          <div class="field"><label>ì‘ì„±ì</label><input id="postAuthor" type="text" required readonly /></div>
        </div>

        <!-- Markdown toolbar -->
        <div class="md-toolbar" id="editorToolbar">
          <button type="button" class="btn secondary" id="btnTogglePreview">ë¯¸ë¦¬ë³´ê¸°</button>
          <button type="button" class="btn secondary" id="btnInsertImage">ì´ë¯¸ì§€ ì‚½ì…</button>
          <input type="file" id="imgFileInput" accept="image/*" hidden />
        </div>

        <div class="field" style="margin-top:8px" id="editorWrap">
          <label>ë‚´ìš© (ë§ˆí¬ë‹¤ìš´ ì§€ì› Â· ì´ë¯¸ì§€ ë“œë˜ê·¸&ë“œë¡­/ë¶™ì—¬ë„£ê¸° ê°€ëŠ¥)</label>
          <textarea id="postContent" required placeholder="# ì œëª©\n\ní…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê³  ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸Â·ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.\n\n![ì´ë¯¸ì§€ ì„¤ëª…](data:img...)"></textarea>
          <div class="help">ì˜ˆ) <code># ê¸°ë³¸ì ì¸ íŒë§¤ ìˆ˜ìˆ˜ë£Œ</code>, <code>## ë°°ì†¡ë¹„ ìˆ˜ìˆ˜ë£Œ</code>, ë¦¬ìŠ¤íŠ¸ <code>- í•­ëª©</code> / ì´ë¯¸ì§€ <code>![ì„¤ëª…](...)</code></div>
        </div>

        <!-- Rendered preview -->
        <div id="postPreviewWrap" class="field" style="display:none">
          <label>ë¯¸ë¦¬ë³´ê¸°</label>
          <div id="postPreview" class="content-body"></div>
        </div>

        <div class="row" style="justify-content:flex-end; margin-top:14px" id="postActions">
          <button class="btn danger" type="button" id="btnDeletePost" hidden>ì‚­ì œ</button>
          <button class="btn" type="submit">ì €ì¥</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Login Dialog -->
  <dialog id="dlgLogin">
    <div class="dialog-header">
      <div class="chip"><span class="dot"></span><span>ë¡œê·¸ì¸</span></div>
      <button class="btn secondary" id="closeLogin">ë‹«ê¸°</button>
    </div>
    <div class="dialog-body">
      <form id="loginForm">
        <div class="field"><label>ì´ë©”ì¼</label><input id="loginEmail" type="email" required /></div>
        <div class="field"><label>ë¹„ë°€ë²ˆí˜¸</label><input id="loginPw" type="password" required /></div>
        <p class="muted" id="loginMsg"></p>
        <div class="row" style="justify-content:flex-end; margin-top:12px">
          <button class="btn" type="submit">ë¡œê·¸ì¸</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Signup Dialog -->
  <dialog id="dlgSignup">
    <div class="dialog-header">
      <div class="chip"><span class="dot"></span><span>íšŒì›ê°€ì…</span></div>
      <button class="btn secondary" id="closeSignup">ë‹«ê¸°</button>
    </div>
    <div class="dialog-body">
      <form id="signupForm">
        <div class="grid">
          <div class="field"><label>ì´ë©”ì¼</label><input id="suEmail" type="email" required /></div>
          <div class="field"><label>ì´ë¦„</label><input id="suName" type="text" required /></div>
        </div>
        <div class="grid">
          <div class="field"><label>ë¹„ë°€ë²ˆí˜¸ (8ì ì´ìƒ)</label><input id="suPw" type="password" minlength="8" required /></div>
          <div class="field"><label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input id="suPw2" type="password" minlength="8" required /></div>
        </div>
        <p class="muted">ê°€ì… í›„ <b>ê´€ë¦¬ì ìŠ¹ì¸</b> ì „ì—ëŠ” ë¡œê·¸ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        <p class="muted" id="signupMsg"></p>
        <div class="row" style="justify-content:flex-end; margin-top:12px">
          <button class="btn" type="submit">ê°€ì… ì‹ ì²­</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Admin Dialog -->
  <dialog id="dlgAdmin">
    <div class="dialog-header">
      <div class="chip"><span class="dot" style="background:var(--ok)"></span><span>ê´€ë¦¬ì: ì‚¬ìš©ì ìŠ¹ì¸</span></div>
      <button class="btn secondary" id="closeAdmin">ë‹«ê¸°</button>
    </div>
    <div class="dialog-body">
      <div class="toolbar admin-toolbar" id="adminTools">
        <button class="btn secondary" id="btnBackupDownload" title="ë°±ì—… ë‹¤ìš´ë¡œë“œ" aria-label="ë°±ì—… ë‹¤ìš´ë¡œë“œ">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path d="M7 10l5 5 5-5"/><path d="M12 15V3"/></svg>
          <span class="btn-label" style="margin-left:6px">ë°±ì—… ë‹¤ìš´ë¡œë“œ</span>
        </button>
        <button class="btn secondary" id="btnBackupSavePicker" title="íŒŒì¼ë¡œ ì €ì¥" aria-label="íŒŒì¼ë¡œ ì €ì¥">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></svg>
          <span class="btn-label" style="margin-left:6px">íŒŒì¼ë¡œ ì €ì¥</span>
        </button>
        <button class="btn secondary" id="btnBackupImport" title="ê°€ì ¸ì˜¤ê¸°" aria-label="ê°€ì ¸ì˜¤ê¸°">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path d="M7 10l5-5 5 5"/><path d="M12 5v12"/></svg>
          <span class="btn-label" style="margin-left:6px">ê°€ì ¸ì˜¤ê¸°</span>
        </button>
        <button class="btn secondary" id="btnBackupLinkFolder" title="ë°±ì—… í´ë” ì—°ê²°" aria-label="ë°±ì—… í´ë” ì—°ê²°">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
            <path d="M3 7h5l2 2h11v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <path d="M3 7a2 2 0 0 1 2-2h4l2 2"/>
          </svg>
          <span class="btn-label" style="margin-left:6px">ë°±ì—… í´ë” ì—°ê²°</span>
        </button>
        <span id="linkedFolderStatus" class="muted" style="margin-left:6px; display:none;">í´ë” ì—°ê²°ë¨</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>ID</th><th>ì´ë©”ì¼</th><th>ì´ë¦„</th><th>ìƒíƒœ</th><th>ê¶Œí•œ</th><th>ê°€ì…ì¼</th><th>ì•¡ì…˜</th></tr></thead>
          <tbody id="tbodyUsers"></tbody>
        </table>
      </div>
      <p class="muted">ê¸°ë³¸ ê´€ë¦¬ì: <b>admin@example.com / admin1234</b> (ì½”ë“œì— ì‹œë“œë¨)</p>
    </div>
  </dialog>

  <script>
  (function(){
    'use strict';

    /*** =====================================
     *  Utilities & Constants
     * ===================================== */
    const KS = { users:'htmlonly-users-v1', posts:'htmlonly-posts-v1', session:'htmlonly-session-v1', theme:'htmlonly-theme', lastBackup:'htmlonly-last-backup' };
    const uuid = () => (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2));
    const nowStr = (t) => new Date(t).toLocaleString('ko-KR', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
    const esc = (s='') => String(s).replace(/[&<>"']/g, ch => ch==='&'?'&amp;': ch==='<'?'&lt;': ch==='>'?'&gt;': ch==='"'?'&quot;':'&#39;');
    const load = (k, def) => { try { const raw = localStorage.getItem(k); return raw==null ? def : JSON.parse(raw); } catch { return def; } };
    const save = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch (e) { console.warn('localStorage save failed:', e); alert('ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•˜ê±°ë‚˜ ë¸Œë¼ìš°ì € ì •ì±…ìœ¼ë¡œ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); throw e; } };

    const AUTO_BACKUP_MS = 60*60*1000; // 60ë¶„
    let _autoBackupTimer = null;
    let _backupDirHandle = null;

    /*** =====================================
     *  IndexedDB (í´ë” í•¸ë“¤ ë³´ì¡´)
     * ===================================== */
    const FSDB = {
      db: null,
      init(){
        return new Promise((resolve,reject)=>{
          try{
            const req = indexedDB.open('boardBackupDB', 1);
            req.onupgradeneeded = ()=>{
              const db = req.result;
              if(!db.objectStoreNames.contains('fs-handles')){
                db.createObjectStore('fs-handles', { keyPath: 'key' });
              }
            };
            req.onsuccess = ()=>{ FSDB.db = req.result; resolve(FSDB.db); };
            req.onerror = ()=> reject(req.error);
          }catch(e){ reject(e); }
        });
      },
      async setDirHandle(handle){
        if(!window.indexedDB) throw new Error('IndexedDB not supported');
        if(!this.db) await this.init();
        return new Promise((resolve,reject)=>{
          try{
            const tx = this.db.transaction('fs-handles','readwrite');
            tx.objectStore('fs-handles').put({ key:'backup-dir', handle });
            tx.oncomplete = ()=> resolve(true);
            tx.onerror = ()=> reject(tx.error);
          }catch(e){ reject(e); }
        });
      },
      async getDirHandle(){
        if(!window.indexedDB) return null;
        if(!this.db) await this.init();
        return new Promise((resolve,reject)=>{
          try{
            const tx = this.db.transaction('fs-handles','readonly');
            const req = tx.objectStore('fs-handles').get('backup-dir');
            req.onsuccess = ()=> resolve(req.result ? req.result.handle : null);
            req.onerror = ()=> reject(req.error);
          }catch(e){ resolve(null); }
        });
      }
    };

    /*** =====================================
     *  OPFS Helpers
     * ===================================== */
    async function opfsWrite(path, dataBlob){
      if(!(navigator.storage && navigator.storage.getDirectory)) throw new Error('OPFS not supported');
      const root = await navigator.storage.getDirectory();
      const parts = path.split('/');
      let dir = root;
      for(let i=0;i<parts.length-1;i++) dir = await dir.getDirectoryHandle(parts[i], {create:true});
      const fileHandle = await dir.getFileHandle(parts[parts.length-1], {create:true});
      const w = await fileHandle.createWritable();
      await w.write(dataBlob);
      await w.close();
      return true;
    }
    function fmtAgo(ts){ if(!ts) return 'ë°±ì—… ê¸°ë¡ ì—†ìŒ'; const d = Date.now()-ts; const m=Math.floor(d/60000); if(m<1) return 'ë°©ê¸ˆ'; if(m<60) return m+'ë¶„ ì „'; const h=Math.floor(m/60); if(h<24) return h+'ì‹œê°„ ì „'; const day=Math.floor(h/24); return day+'ì¼ ì „'; }

    /*** =====================================
     *  Icons
     * ===================================== */
    function svg(name){ const c='currentColor'; switch(name){
      case 'sun': return `<svg viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>`;
      case 'moon': return `<svg viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>`;
      case 'plus': return `<svg viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>`;
      case 'eraser': return `<svg viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14l-7-7-8 8 4 4h7l4-5z"/></svg>`;
      case 'logout': return `<svg viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><path d="M16 17l5-5-5-5"/><path d="M21 12H9"/></svg>`;
      case 'shield': return `<svg viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`;
      case 'close': return `<svg viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>`;
      case 'trash': return `<svg viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>`;
      case 'save': return `<svg viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></svg>`;
      case 'check': return `<svg viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>`;
      case 'x': return `<svg viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>`;
      case 'edit': return `<svg viewBox="0 0 24 24" fill="none" stroke="${c}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>`;
      default: return '';
    }}

    /*** =====================================
     *  Markdown renderer (safe subset)
     * ===================================== */
    function renderMarkdown(mdRaw=''){
      // Escape HTML first
      let md = String(mdRaw).replace(/[&<>]/g, m => m==='&'?'&amp;':m==='<'?'&lt;':'&gt;');

      // Code span `code`
      md = md.replace(/`([^`]+)`/g, '<code>$1</code>');

      // Images ![alt](src)
      md = md.replace(/!\[([^\]]*)\]\(([^\)]+)\)/g, (m, alt, src) => {
        const a = esc(alt);
        const s = src.trim();
        // Only allow data: or http(s): images
        if(!/^data:image\/(png|jpe?g|gif|webp);base64,/i.test(s) && !/^https?:\/\//i.test(s)) return m; // keep raw if not allowed
        return `<img alt=\"${a}\" src=\"${s}\" referrerpolicy=\"no-referrer\" loading=\"lazy\">`; 
      });

      // Bold **text** and italic *text*
      md = md.replace(/\*\*([^*]+)\*\*/g, '<b>$1</b>');
      md = md.replace(/\*([^*]+)\*/g, '<i>$1</i>');

      // Headings ###### .. #
      for(let n=6;n>=1;n--){
        const re = new RegExp(`^${'#'.repeat(n)}\\s+(.+)$`, 'gm');
        md = md.replace(re, `<h${n}>$1</h${n}>`);
      }

      // Lists (ordered and unordered) - group consecutive lines
      md = md.replace(/(^|\n)(?:-\s+.+(?:\n-\s+.+)*)/g, block => {
        const items = block.trim().split(/\n/).map(l=> l.replace(/^[-]\s+/, '').trim()).filter(Boolean);
        if(items.length<1) return block;
        return '\n<ul>' + items.map(it=> `<li>${it}</li>`).join('') + '</ul>';
      });
      md = md.replace(/(^|\n)(?:\d+\.\s+.+(?:\n\d+\.\s+.+)*)/g, block => {
        const items = block.trim().split(/\n/).map(l=> l.replace(/^\d+\.\s+/, '').trim()).filter(Boolean);
        if(items.length<1) return block;
        return '\n<ol>' + items.map(it=> `<li>${it}</li>`).join('') + '</ol>';
      });

      // Paragraphs: split by double newlines
      const parts = md.split(/\n{2,}/).map(seg=> seg.trim()).filter(Boolean);
      const html = parts.map(seg => /^(<h\d|<ul>|<ol>|<img|<blockquote|<pre|<p|<table|<code)/.test(seg) ? seg : `<p>${seg.replace(/\n/g,'<br>')}</p>`).join('\n');
      return html;
    }

    /*** =====================================
     *  Image helpers: paste/drag-drop/upload + resize to 1280px
     * ===================================== */
    function insertAtCursor(textarea, text){
      const start = textarea.selectionStart ?? textarea.value.length;
      const end = textarea.selectionEnd ?? textarea.value.length;
      const before = textarea.value.slice(0, start);
      const after = textarea.value.slice(end);
      textarea.value = before + text + after;
      const pos = start + text.length;
      textarea.selectionStart = textarea.selectionEnd = pos;
      textarea.dispatchEvent(new Event('input', {bubbles:true}));
      textarea.focus();
    }

    function readFileAsImageBitmap(file){
      return new Promise((resolve,reject)=>{
        // Prefer createImageBitmap when available
        if(typeof createImageBitmap === 'function'){
          const fr = new FileReader();
          fr.onload = ()=>{
            createImageBitmap(new Blob([fr.result]))
              .then(resolve)
              .catch(reject);
          };
          fr.onerror = ()=> reject(fr.error);
          fr.readAsArrayBuffer(file);
        } else {
          // Fallback: use Image element + DataURL
          const fr = new FileReader();
          fr.onload = ()=>{
            const img = new Image();
            img.onload = ()=> resolve(img);
            img.onerror = ()=> reject(new Error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨'));
            img.src = fr.result;
          };
          fr.onerror = ()=> reject(fr.error);
          fr.readAsDataURL(file);
        }
      });
    }

    async function resizeToDataURL(file, maxW=1280){
      try{
        const ib = await readFileAsImageBitmap(file);
        const w0 = ib.width || 1, h0 = ib.height || 1;
        const ratio = Math.min(1, maxW / w0);
        const w = Math.max(1, Math.round(w0 * ratio));
        const h = Math.max(1, Math.round(h0 * ratio));
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(ib, 0, 0, w, h);
        const mime = (/png/i.test(file.type) ? 'image/png' : 'image/jpeg');
        return canvas.toDataURL(mime, 0.9);
      }catch(e){
        console.warn('resize failed, fallback to readAsDataURL', e);
        return await new Promise((resolve,reject)=>{
          const fr = new FileReader();
          fr.onload = ()=> resolve(fr.result);
          fr.onerror = ()=> reject(fr.error);
          fr.readAsDataURL(file);
        });
      }
    }

    async function handleFilesToMarkdown(files, textarea){
      for(const f of files){
        if(!/^image\//i.test(f.type)) continue;
        const dataURL = await resizeToDataURL(f, 1280);
        insertAtCursor(textarea, `\n\n![ì´ë¯¸ì§€](${dataURL})\n\n`);
      }
    }

    /*** =====================================
     *  DOM
     * ===================================== */
    const $ = (id)=> document.getElementById(id);
    const $welcome = $('welcome');
    const $btnLogin = $('btnLogin');
    const $btnSignup = $('btnSignup');
    const $btnLogout = $('btnLogout');
    const $btnAdmin = $('btnAdmin');
    const $btnTheme = $('btnTheme');
    const $q = $('q');
    const $resetSearch = $('resetSearch');
    const $btnNewPost = $('btnNewPost');
    const $tbody = $('tbody');
    const $emptyPosts = $('emptyPosts');
    const $pager = $('pager');

    const $dlgPost = $('dlgPost');
    const $dlgPostMode = $('dlgPostMode');
    const $closePost = $('closePost');
    const $postForm = $('postForm');
    const $postId = $('postId');
    const $postTitle = $('postTitle');
    const $postAuthor = $('postAuthor');
    const $postContent = $('postContent');
    const $btnDeletePost = $('btnDeletePost');
    const $btnTogglePreview = $('btnTogglePreview');
    const $btnInsertImage = $('btnInsertImage');
    const $imgFileInput = $('imgFileInput');
    const $postPreviewWrap = $('postPreviewWrap');
    const $postPreview = $('postPreview');
    const $postMeta = $('postMeta');
    const $editorWrap = $('editorWrap');
    const $postActions = $('postActions');

    const $dlgLogin = $('dlgLogin');
    const $closeLogin = $('closeLogin');
    const $loginForm = $('loginForm');
    const $loginEmail = $('loginEmail');
    const $loginPw = $('loginPw');
    const $loginMsg = $('loginMsg');

    const $dlgSignup = $('dlgSignup');
    const $closeSignup = $('closeSignup');
    const $signupForm = $('signupForm');
    const $suEmail = $('suEmail');
    const $suName = $('suName');
    const $suPw = $('suPw');
    const $suPw2 = $('suPw2');
    const $signupMsg = $('signupMsg');

    const $dlgAdmin = $('dlgAdmin');
    const $closeAdmin = $('closeAdmin');
    const $tbodyUsers = $('tbodyUsers');

    // admin backup buttons (lazy refs)
    const $btnBackupDownload = () => $('btnBackupDownload');
    const $btnBackupSavePicker = () => $('btnBackupSavePicker');
    const $btnBackupImport = () => $('btnBackupImport');
    const $btnBackupLinkFolder = () => $('btnBackupLinkFolder');

    /*** =====================================
     *  Seed
     * ===================================== */
    (function seed(){
      let users = load(KS.users, []);
      let posts = load(KS.posts, []);
      let admin = users.find(u=>u.email==='admin@example.com');
      if(!admin){
        admin = { id:uuid(), email:'admin@example.com', name:'ê´€ë¦¬ì', password:'admin1234', role:'ADMIN', status:'APPROVED', createdAt:Date.now() };
        users.push(admin); save(KS.users, users);
      }
      if(posts.length===0){
        const sample = `# í™˜ì˜í•©ë‹ˆë‹¤ ğŸ‘‹\n\nì´ ë°ëª¨ëŠ” ë‹¨ì¼ HTML íŒŒì¼ì…ë‹ˆë‹¤.\n\nì´ë¯¸ì§€ë¥¼ ì´ë ‡ê²Œ ë„£ì„ ìˆ˜ ìˆì–´ìš”:\n\n![ìƒ˜í”Œ](https://picsum.photos/seed/wbs/800/400)`;
        posts.push({ id:uuid(), title:'í™˜ì˜í•©ë‹ˆë‹¤ ğŸ‘‹', author:admin.name, ownerId:admin.id, content:sample, createdAt:Date.now() });
        save(KS.posts, posts);
      } else {
        let changed=false; for(const p of posts){ if(!('ownerId' in p)){ p.ownerId=admin.id; changed=true; } } if(changed) save(KS.posts, posts);
      }
    })();

    /*** =====================================
     *  Session / Auth helpers
     * ===================================== */
    const getSession = ()=> load(KS.session, null);
    const setSession = (userId)=> save(KS.session, userId? {userId}: null);
    const currentUser = ()=>{ const s=getSession(); if(!s) return null; return load(KS.users, []).find(u=>u.id===s.userId)||null; };

    /*** =====================================
     *  Theme
     * ===================================== */
    function applyTheme(theme){
      const t=(theme==='dark'||theme==='light')? theme : 'light';
      document.documentElement.setAttribute('data-theme', t);
      if($btnTheme){
        $btnTheme.setAttribute('aria-label', t==='dark'?'ë¼ì´íŠ¸ëª¨ë“œ':'ë‹¤í¬ëª¨ë“œ');
        $btnTheme.title = t==='dark'?'ë¼ì´íŠ¸ëª¨ë“œ':'ë‹¤í¬ëª¨ë“œ';
        $btnTheme.innerHTML = t==='dark'? svg('sun') : svg('moon');
      }
      save(KS.theme, t);
    }
    function initTheme(){
      let saved=load(KS.theme,null);
      if(saved!=='light' && saved!=='dark'){
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        saved = prefersDark? 'dark':'light';
      }
      applyTheme(saved);
      if($btnTheme){ $btnTheme.addEventListener('click', ()=>{
        const cur=document.documentElement.getAttribute('data-theme')||'light';
        applyTheme(cur==='light'?'dark':'light');
      }); }
    }

    /*** =====================================
     *  Board state & render
     * ===================================== */
    const state = { q:'', page:1, size:10, total:0 };

    function renderNavbar(){
      const me=currentUser();
      if(me){
        $welcome.textContent = `${me.name} (${me.status}${me.role==='ADMIN'?', ADMIN':''})`;
        $btnLogin.hidden=true; $btnSignup.hidden=true; $btnLogout.hidden=false; $btnAdmin.hidden = me.role!=='ADMIN';
      } else {
        $welcome.textContent='';
        $btnLogin.hidden=false; $btnSignup.hidden=false; $btnLogout.hidden=true; $btnAdmin.hidden=true;
      }
    }

    function filteredPosts(){
      const posts = load(KS.posts, []).sort((a,b)=> b.createdAt - a.createdAt);
      const q = state.q.trim().toLowerCase();
      if(!q) return posts;
      return posts.filter(p=> [p.title,p.author,p.content].some(v=> (v||'').toLowerCase().includes(q)) );
    }

    function renderPosts(){
      const list = filteredPosts();
      state.total = list.length;
      const start = (state.page-1)*state.size;
      const pageRows = list.slice(start, start+state.size);

      $tbody.innerHTML='';
      if(pageRows.length===0){ $emptyPosts.hidden=false; $pager.innerHTML=''; return; }
      $emptyPosts.hidden=true;

      pageRows.forEach((p,idx)=>{
        const tr=document.createElement('tr');
        tr.classList.add('reveal');
        tr.innerHTML = '<td data-th="ë²ˆí˜¸">'+(start+idx+1)+'</td>'+
                       '<td data-th="ì œëª©" class="title-cell"><span class="title-wrap"><a href="#" data-id="'+p.id+'">'+esc(p.title)+'</a> <button class="icon-btn icon-only" data-edit-id="'+p.id+'" title="í¸ì§‘" hidden>'+svg('edit')+'</button></span></td>'+
                       '<td data-th="ì‘ì„±ì">'+esc(p.author)+'</td>'+
                       '<td data-th="ì‘ì„±ì¼" class="muted">'+nowStr(p.createdAt)+'</td>';
        const link = tr.querySelector('a');
        const editBtn = tr.querySelector('.icon-btn');
        const me = currentUser();
        const canEdit = !!(me && (me.role==='ADMIN' || p.ownerId===me.id));
        if(canEdit){ editBtn.hidden=false; editBtn.addEventListener('click', (e)=>{ e.preventDefault(); openPost('edit', p.id); }); }
        link.addEventListener('click', (e)=>{ e.preventDefault(); openPost('view', p.id); });
        $tbody.appendChild(tr);
        requestAnimationFrame(()=> setTimeout(()=> tr.classList.add('is-visible'), idx*35));
      });
      renderPager();
      bindRipples();
    }

    function renderPager(){
      const pages = Math.max(1, Math.ceil(state.total/state.size));
      if(state.page>pages) state.page=pages;
      const btn=(label,p,active=false,disabled=false)=> '<button class="page-btn '+(active?'active':'')+'" '+(disabled?'disabled':'')+' data-page="'+p+'">'+label+'</button>';
      const items=[];
      items.push(btn('Â«',1,false,state.page===1));
      items.push(btn('â€¹',Math.max(1,state.page-1),false,state.page===1));
      for(let i=Math.max(1,state.page-2); i<=Math.min(pages,state.page+2); i++){ items.push(btn(String(i),i,i===state.page)); }
      items.push(btn('â€º',Math.min(pages,state.page+1),false,state.page===pages));
      items.push(btn('Â»',pages,false,state.page===pages));
      $pager.innerHTML = items.join('');
      $pager.querySelectorAll('button[data-page]').forEach(b=> b.addEventListener('click', ()=>{ state.page=Number(b.dataset.page); renderPosts(); }));
      bindRipples();
    }

    /*** =====================================
     *  Posts CRUD
     * ===================================== */
    const postById = (id)=> load(KS.posts, []).find(p=>p.id===id);
    function createPost(payload){ const me=currentUser(); const list=load(KS.posts, []); list.push({...payload, ownerId: me? me.id : null, id:uuid(), createdAt:Date.now()}); save(KS.posts,list); }
    function updatePost(id, patch){ const list=load(KS.posts, []); const i=list.findIndex(p=>p.id===id); if(i<0) return; list[i]={...list[i],...patch}; save(KS.posts,list); }
    function deletePost(id){ save(KS.posts, load(KS.posts, []).filter(p=>p.id!==id)); }

    function setEditorMode({editable, showPreview}){
      // ì•ˆì „ ê°€ë“œ(ìš”ì†Œ ì¡´ì¬ í™•ì¸)
      if(!$postMeta || !$editorWrap || !$postActions || !$postPreviewWrap){ return; }
      // ì œëª©/ì‘ì„±ì ì˜ì—­ì€ í•­ìƒ í‘œì‹œ(ë³´ê¸° ëª¨ë“œì—ì„œë„ í™•ì¸ ê°€ëŠ¥)
      $postMeta.style.display = '';
      // ì—ë””í„° ì˜ì—­: í¸ì§‘ ê°€ëŠ¥ + ë¯¸ë¦¬ë³´ê¸° ì•„ë‹˜
      $editorWrap.style.display = (editable && !showPreview) ? '' : 'none';
      // ì•¡ì…˜ ë²„íŠ¼(ì €ì¥/ì‚­ì œ): í¸ì§‘ ëª¨ë“œì—ì„œë§Œ
      $postActions.style.display = editable ? '' : 'none';
      // íˆ´ë°”: í¸ì§‘ ëª¨ë“œì—ì„œë§Œ
      const $toolbar = $('editorToolbar');
      if($toolbar) $toolbar.style.display = editable ? 'flex' : 'none';
      // ë¯¸ë¦¬ë³´ê¸°: showPreviewê°€ trueì¼ ë•Œë§Œ
      $postPreviewWrap.style.display = showPreview ? '' : 'none';
    }

    function openPost(mode='new', id=null){
      const me = currentUser();
      if(!me){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
      if(me.status!=='APPROVED'){ alert('ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }

      $dlgPostMode.textContent = mode==='new' ? 'ìƒˆ ê¸€' : (mode==='edit' ? 'ê¸€ ìˆ˜ì •' : 'ê¸€ ë³´ê¸°');

      let editable = true; let post=null;
      if(mode==='new'){
        $postId.value=''; $postTitle.value=''; $postAuthor.value = me.name || ''; $postContent.value='';
        $postPreview.innerHTML = '';
        setEditorMode({editable:true, showPreview:false});
      } else {
        post = postById(id); if(!post) return;
        const canEdit = !!(me && (me.role==='ADMIN' || post.ownerId===me.id));
        editable = (mode==='edit' && canEdit);
        $postId.value=post.id; $postTitle.value=post.title; $postAuthor.value=post.author; $postContent.value=post.content;
        if(mode==='view'){
          $postPreview.innerHTML = renderMarkdown(post.content||'');
          setEditorMode({editable:false, showPreview:true});
        } else if(mode==='edit'){
          $postPreview.innerHTML = '';
          setEditorMode({editable:true, showPreview:false});
        }
      }

      $btnDeletePost.hidden = !(mode==='edit');
      [$postTitle, $postContent].forEach(el=>{ el.readOnly = !editable; el.disabled = !editable; });
      $postAuthor.readOnly = true; $postAuthor.disabled = false; // í•­ìƒ ì½ê¸° ì „ìš©
      const submitBtn = $postForm.querySelector('button[type="submit"]');
      if(submitBtn) submitBtn.style.display = editable ? '' : 'none';

      if($dlgPost.showModal) $dlgPost.showModal(); else $dlgPost.show();
      if(editable) $postTitle.focus();
    }

    /*** =====================================
     *  Users / Auth
     * ===================================== */
    const listUsers = ()=> load(KS.users, []).sort((a,b)=> b.createdAt-a.createdAt);
    const userByEmail = (email)=> listUsers().find(u=>u.email===email);
    function createUser({email,name,password}){
      const users = listUsers();
      if(users.find(u=>u.email===email)) throw new Error('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.');
      if(typeof password !== 'string') throw new Error('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      // 8ì ì´ìƒ + ì˜ë¬¸/ìˆ«ì ì¡°í•©
      const strongPw = /^(?=.*[0-9])(?=.*[A-Za-z]).{8,}$/.test(password);
      if(!strongPw) throw new Error('ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒ, ì˜ë¬¸/ìˆ«ì ì¡°í•©ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
      users.push({ id:uuid(), email, name, password, role:'USER', status:'PENDING', createdAt:Date.now() });
      save(KS.users, users);
    }
    function approveUser(id){ const users=listUsers(); const i=users.findIndex(u=>u.id===id); if(i<0) return; users[i].status='APPROVED'; save(KS.users, users); }
    function rejectUser(id){ const users=listUsers(); const i=users.findIndex(u=>u.id===id); if(i<0) return; users[i].status='REJECTED'; save(KS.users, users); }

    function tryLogin(email,pw){
      const u = userByEmail(email);
      if(!u) return {ok:false, msg:'ê³„ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'};
      if(u.password!==pw) return {ok:false, msg:'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'};
      if(u.status!=='APPROVED') return {ok:false, msg:'ìŠ¹ì¸ ëŒ€ê¸° ìƒíƒœì…ë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ í›„ ë¡œê·¸ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.'};
      setSession(u.id); return {ok:true, user:u};
    }

    function renderUsers(){
      const me=currentUser(); if(!me || me.role!=='ADMIN'){ alert('ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
      const users=listUsers();
      $tbodyUsers.innerHTML='';
      users.forEach(u=>{
        const tr=document.createElement('tr');
        tr.innerHTML = '<td>'+esc(String(u.id).slice(0,8))+'</td>'+
                       '<td>'+esc(u.email)+'</td>'+
                       '<td>'+esc(u.name)+'</td>'+
                       '<td>'+u.status+'</td>'+
                       '<td>'+u.role+'</td>'+
                       '<td class="muted">'+nowStr(u.createdAt)+'</td>'+
                       '<td>'+
                         '<button class="btn ok icon-only" data-act="approve" data-id="'+u.id+'" '+(u.status==='APPROVED'?'disabled':'')+' title="ìŠ¹ì¸" aria-label="ìŠ¹ì¸">'+svg('check')+'</button> '+
                         '<button class="btn danger icon-only" data-act="reject" data-id="'+u.id+'" '+(u.status==='REJECTED'?'disabled':'')+' title="ê±°ì ˆ" aria-label="ê±°ì ˆ">'+svg('x')+'</button>'+
                       '</td>';
        $tbodyUsers.appendChild(tr);
      });
      $tbodyUsers.querySelectorAll('[data-act]').forEach(b=>{
        b.addEventListener('click', ()=>{
          const id=b.getAttribute('data-id');
          const act=b.getAttribute('data-act');
          if(act==='approve') approveUser(id); else if(act==='reject') rejectUser(id);
          renderUsers();
        });
      });
      ensureAdminBackupBindings();
    }

    /*** =====================================
     *  Manual Backup/Restore (Admin only)
     * ===================================== */
    function requireAdmin(){
      const me = currentUser();
      if(!me || me.role !== 'ADMIN'){
        alert('ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        throw new Error('ADMIN_ONLY');
      }
    }

    function downloadBackupNow(){
      try{
        requireAdmin();
        const payload = { users: load(KS.users, []), posts: load(KS.posts, []), ts: Date.now() };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'board-backup-' + new Date().toISOString().slice(0,19).replace(/[:T]/g,'-') + '.json';
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
        alert('ë°±ì—… íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.');
      }catch(e){ if(e && e.message==='ADMIN_ONLY') return; alert('ë°±ì—… ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); console.error(e); }
    }

    async function saveBackupWithPicker(){
      try{
        requireAdmin();
        const payload = { users: load(KS.users, []), posts: load(KS.posts, []), ts: Date.now() };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        if(window.showSaveFilePicker){
          const handle = await showSaveFilePicker({ suggestedName: 'board-backup.json', types:[{ description:'JSON', accept:{'application/json':['.json']} }] });
          const w = await handle.createWritable(); await w.write(blob); await w.close();
          alert('íŒŒì¼ë¡œ ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
          downloadBackupNow();
        }
      }catch(e){ if(e && e.message==='ADMIN_ONLY') return; alert('íŒŒì¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); console.error(e); }
    }

    async function restoreFromFile(){
      function applyJsonSync(text){
        const data = JSON.parse(text);
        if(!(data && Array.isArray(data.users) && Array.isArray(data.posts))) throw new Error('í˜•ì‹ ë¶ˆì¼ì¹˜');
        save(KS.users, data.users); save(KS.posts, data.posts);
        renderNavbar(); renderPosts(); updateBackupStatus();
        alert('ë³µì›ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
      try{
        requireAdmin();
        if(window.showOpenFilePicker){
          const [handle] = await showOpenFilePicker({ types:[{ description:'JSON', accept:{'application/json':['.json']} }] });
          const file = await handle.getFile(); const text = await file.text();
          applyJsonSync(text);
        } else {
          const input = document.createElement('input'); input.type='file'; input.accept='application/json'; input.style.display='none';
          input.addEventListener('change', async ()=>{ const f=input.files && input.files[0]; if(!f) return; const text = await f.text(); applyJsonSync(text); input.remove(); });
          document.body.appendChild(input); input.click();
        }
      }catch(e){ if(e && e.message==='ADMIN_ONLY') return; alert('ê°€ì ¸ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); console.error(e); }
    }

    function ensureAdminBackupBindings(){
      const pairs = [
        [$btnBackupDownload(), downloadBackupNow],
        [$btnBackupSavePicker(), saveBackupWithPicker],
        [$btnBackupImport(), restoreFromFile],
        [$btnBackupLinkFolder(), connectBackupFolder]
      ];
      pairs.forEach(([el, fn])=>{
        if(!el) return;
        if(el.dataset.bound==='1') return;
        el.addEventListener('click', fn);
        el.dataset.bound='1';
      });
    }

    /*** =====================================
     *  Auto Backup (OPFS + ì„ íƒ í´ë”)
     * ===================================== */
    async function runAutoBackup(){
      try{
        const payload = { users: load(KS.users, []), posts: load(KS.posts, []), ts: Date.now() };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
        // OPFS write
        await opfsWrite('backups/board-backup.json', blob);
        save(KS.lastBackup, Date.now());
        updateBackupStatus();
        // External folder mirror
        if(_backupDirHandle){
          try{
            let perm = _backupDirHandle.queryPermission ? await _backupDirHandle.queryPermission({mode:'readwrite'}) : 'prompt';
            if(perm !== 'granted' && _backupDirHandle.requestPermission){ perm = await _backupDirHandle.requestPermission({mode:'readwrite'}); }
            if(perm === 'granted'){
              const name = 'board-backup-' + new Date().toISOString().slice(0,19).replace(/[:T]/g,'-') + '.json';
              const fh = await _backupDirHandle.getFileHandle(name, {create:true});
              const w2 = await fh.createWritable(); await w2.write(blob); await w2.close();
            }
          }catch(e){ console.warn('External folder backup failed:', e); }
        }
      }catch(err){
        console.warn('Auto backup failed:', err);
        if(!(navigator.storage && navigator.storage.getDirectory)){
          const $s = document.getElementById('backupStatus'); if($s) $s.style.display='none';
          if(_autoBackupTimer) { clearInterval(_autoBackupTimer); _autoBackupTimer = null; }
        }
      }
    }

    function updateBackupStatus(){
      const $s = document.getElementById('backupStatus'); const $t = document.getElementById('backupText');
      if(!$s||!$t) return;
      const ts = load(KS.lastBackup, null);
      $s.style.display = 'inline-flex';
      $t.textContent = 'ìë™ ë°±ì—…: ' + fmtAgo(ts);
    }

    async function connectBackupFolder(){
      requireAdmin();
      if(!window.showDirectoryPicker){ alert('ì´ ë¸Œë¼ìš°ì €ëŠ” í´ë” ì—°ê²°ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (í¬ë¡¬/ì—£ì§€ ìµœì‹  ê¶Œì¥)'); return; }
      try{
        const handle = await showDirectoryPicker({ id:'board-backups', mode:'readwrite' });
        let perm = handle.queryPermission ? await handle.queryPermission({mode:'readwrite'}) : 'prompt';
        if(perm !== 'granted' && handle.requestPermission){ perm = await handle.requestPermission({mode:'readwrite'}); }
        if(perm !== 'granted'){ alert('í´ë”ì— ì“°ê¸° ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
        _backupDirHandle = handle;
        try{ await FSDB.setDirHandle(handle); }catch(e){ console.warn('Could not persist handle to IDB', e); }
        updateLinkedFolderStatus(true);
        alert('ë°±ì—… í´ë”ê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }catch(e){ console.error(e); alert('í´ë” ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
    }

    function updateLinkedFolderStatus(connected){
      const hint = document.getElementById('linkedFolderStatus');
      const btn = document.getElementById('btnBackupLinkFolder');
      if(hint) hint.style.display = connected ? 'inline' : 'none';
      if(btn){ const label = btn.querySelector('.btn-label'); if(label) label.textContent = connected ? 'í´ë” ë³€ê²½' : 'ë°±ì—… í´ë” ì—°ê²°'; }
    }

    async function tryRestoreBackupFolder(){
      try{
        if(!window.indexedDB) return;
        const handle = await FSDB.getDirHandle();
        if(handle){
          let perm = handle.queryPermission ? await handle.queryPermission({mode:'readwrite'}) : 'prompt';
          if(perm !== 'granted' && handle.requestPermission){ perm = await handle.requestPermission({mode:'readwrite'}); }
          if(perm === 'granted'){ _backupDirHandle = handle; updateLinkedFolderStatus(true); }
        }
      }catch(e){ console.warn('restore folder handle failed', e); }
    }

    /*** =====================================
     *  Editor events (image + preview)
     * ===================================== */
    function refreshPreview(){
      $postPreview.innerHTML = renderMarkdown($postContent.value||'');
    }

    if($btnTogglePreview){
      $btnTogglePreview.addEventListener('click', ()=>{
        const showing = $postPreviewWrap && $postPreviewWrap.style.display !== 'none';
        if(showing){
          // turn off preview, show editor
          if($postPreviewWrap) $postPreviewWrap.style.display='none';
          if($editorWrap) $editorWrap.style.display='';
          $btnTogglePreview.textContent='ë¯¸ë¦¬ë³´ê¸°';
        }else{
          refreshPreview();
          if($postPreviewWrap) $postPreviewWrap.style.display='';
          if($editorWrap) $editorWrap.style.display='none';
          $btnTogglePreview.textContent='í¸ì§‘í•˜ê¸°';
        }
      });
    }

    if($btnInsertImage && $imgFileInput){
      $btnInsertImage.addEventListener('click', ()=> $imgFileInput.click());
      $imgFileInput.addEventListener('change', async (e)=>{
        const files = Array.from(e.target.files||[]);
        await handleFilesToMarkdown(files, $postContent);
        if($postPreviewWrap.style.display!=='none') refreshPreview();
        $imgFileInput.value='';
      });
    }

    // Paste image
    if($postContent){
      $postContent.addEventListener('paste', async (e)=>{
        const items = Array.from(e.clipboardData?.items||[]);
        const files = items.filter(it=> it.kind==='file').map(it=> it.getAsFile()).filter(Boolean);
        if(files.length){ e.preventDefault(); await handleFilesToMarkdown(files, $postContent); if($postPreviewWrap && $postPreviewWrap.style.display!=='none') refreshPreview(); }
      });
      // Drag & drop image
      $postContent.addEventListener('dragover', e=>{ e.preventDefault(); });
      $postContent.addEventListener('drop', async (e)=>{
        e.preventDefault(); const files = Array.from(e.dataTransfer?.files||[]); if(files.length){ await handleFilesToMarkdown(files, $postContent); if($postPreviewWrap && $postPreviewWrap.style.display!=='none') refreshPreview(); }
      });
    }

    /*** =====================================
     *  Motion
     * ===================================== */
    function bindRipples(){
      const targets = document.querySelectorAll('.btn, .page-btn, .icon-btn');
      targets.forEach(el=>{
        if(el.dataset.rippleBound==='1') return; el.dataset.rippleBound='1';
        el.addEventListener('click', (e)=>{
          const rect=el.getBoundingClientRect();
          const cx = rect.width/2, cy = rect.height/2;
          const x = (e && e.clientX) ? (e.clientX-rect.left) : cx;
          const y = (e && e.clientY) ? (e.clientY-rect.top) : cy;
          const span=document.createElement('span'); span.className='ripple'; span.style.left=x+'px'; span.style.top=y+'px';
          el.appendChild(span); span.addEventListener('animationend', ()=> span.remove());
        });
      });
    }
    function entrance(){
      document.querySelectorAll('header, .panel').forEach((el,i)=>{
        el.classList.add('reveal'); requestAnimationFrame(()=> setTimeout(()=> el.classList.add('is-visible'), 60+i*90));
      });
    }

    /*** =====================================
     *  Events
     * ===================================== */
    if($btnLogin) $btnLogin.addEventListener('click', ()=>{ $loginMsg.textContent=''; $loginForm.reset(); if($dlgLogin.showModal) $dlgLogin.showModal(); else $dlgLogin.show(); $loginEmail.focus(); });
    if($btnSignup) $btnSignup.addEventListener('click', ()=>{ $signupMsg.textContent=''; $signupForm.reset(); if($dlgSignup.showModal) $dlgSignup.showModal(); else $dlgSignup.show(); $suEmail.focus(); });
    if($btnLogout) $btnLogout.addEventListener('click', ()=>{ setSession(null); renderNavbar(); renderPosts(); alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.'); });
    if($btnAdmin) $btnAdmin.addEventListener('click', ()=>{ renderUsers(); if($dlgAdmin.showModal) $dlgAdmin.showModal(); else $dlgAdmin.show(); });

    if($closeLogin) $closeLogin.addEventListener('click', ()=> $dlgLogin.close());
    if($closeSignup) $closeSignup.addEventListener('click', ()=> $dlgSignup.close());
    if($closeAdmin) $closeAdmin.addEventListener('click', ()=> $dlgAdmin.close());

    if($loginForm) $loginForm.addEventListener('submit', (e)=>{
      e.preventDefault(); const {ok,msg} = tryLogin($loginEmail.value.trim(), $loginPw.value.trim());
      if(!ok){ $loginMsg.textContent=msg; return; }
      $dlgLogin.close(); renderNavbar(); renderPosts();
    });

    if($signupForm) $signupForm.addEventListener('submit', (e)=>{
      e.preventDefault(); const email=$suEmail.value.trim(); const name=$suName.value.trim(); const pw=$suPw.value; const pw2=$suPw2.value;
      if(pw!==pw2){ $signupMsg.textContent='ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'; return; }
      try{ createUser({email,name,password:pw}); $signupMsg.textContent='ê°€ì… ì‹ ì²­ ì™„ë£Œ! ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.'; }
      catch(err){ $signupMsg.textContent=String(err.message||err); }
    });

    if($btnNewPost) $btnNewPost.addEventListener('click', ()=> openPost('new'));
    if($closePost) $closePost.addEventListener('click', ()=> $dlgPost.close());

    if($postForm) $postForm.addEventListener('submit', (e)=>{
      e.preventDefault(); const me=currentUser(); if(!me){ alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; } if(me.status!=='APPROVED'){ alert('ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }
      const id = $postId.value;
      let authorFixed = '';
      if(id){ const p = postById(id); const meNow = currentUser(); authorFixed = (p && p.author) ? p.author : (meNow ? meNow.name : ''); }
      else { const meNow = currentUser(); authorFixed = meNow ? meNow.name : ''; }
      const payload = { title: $postTitle.value.trim(), author: authorFixed, content: $postContent.value.trim() };
      if(!payload.title||!payload.author||!payload.content){ alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      if(id){ const p=postById(id); const canEdit=!!(me && (me.role==='ADMIN'||p.ownerId===me.id)); if(!canEdit){ alert('ì´ ê¸€ì„ ìˆ˜ì •í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'); return; } updatePost(id,payload); }
      else { createPost(payload); }
      $dlgPost.close(); renderPosts();
    });

    if($btnDeletePost) $btnDeletePost.addEventListener('click', ()=>{
      const id=$postId.value; if(!id) return; const me=currentUser(); const p=postById(id); const canEdit=!!(me && (me.role==='ADMIN'||p.ownerId===me.id));
      if(!canEdit){ alert('ì´ ê¸€ì„ ì‚­ì œí•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
      if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){ deletePost(id); $dlgPost.close(); renderPosts(); }
    });

    if($q) $q.addEventListener('input', ()=>{ state.q=$q.value; state.page=1; renderPosts(); });
    if($resetSearch) $resetSearch.addEventListener('click', ()=>{ $q.value=''; state.q=''; state.page=1; renderPosts(); });

    /*** =====================================
     *  Init
     * ===================================== */
    initTheme();
    renderNavbar();
    renderPosts();
    entrance();
    bindRipples();
    updateBackupStatus();
    tryRestoreBackupFolder();

    if(navigator.storage && navigator.storage.getDirectory){
      if(navigator.storage && navigator.storage.persist){ try{ navigator.storage.persist(); }catch{ /* noop */ } }
      _autoBackupTimer = setInterval(runAutoBackup, AUTO_BACKUP_MS);
      // ì´ˆê¸° ìë™ ë°±ì—…ì€ ì¦‰ì‹œ ì‹¤í–‰í•˜ì§€ ì•Šê³ , ì£¼ê¸° ì´í›„ì— ì‹¤í–‰
      setTimeout(runAutoBackup, AUTO_BACKUP_MS);
    }
  })();
</script>
</body>
</html>
